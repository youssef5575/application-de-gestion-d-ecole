<div class="affectation-container">
  <mat-card>
    <mat-card-header>
      <mat-card-title>
        <button mat-icon-button (click)="goBack()">
          <mat-icon>arrow_back</mat-icon>
        </button>
        Affecter Enseignants aux Matières
      </mat-card-title>
    </mat-card-header>

    <mat-card-content>
      <!-- FORMULAIRE D'AFFECTATION -->
      <div class="affectation-form">
        <h3>Nouvelle Affectation</h3>
        <form [formGroup]="affectationForm" (ngSubmit)="onSubmit()">
          <div class="form-row">
            <mat-form-field appearance="outline" class="half-width">
              <mat-label>Sélectionner un enseignant</mat-label>
              <mat-select formControlName="enseignantId">
                <mat-option *ngFor="let enseignant of enseignants" [value]="enseignant.id">
                  {{ enseignant.matricule }} - {{ enseignant.nom }} {{ enseignant.prenom }}
                </mat-option>
              </mat-select>
              <mat-error *ngIf="affectationForm.get('enseignantId')?.hasError('required')">
                Enseignant requis
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline" class="half-width">
              <mat-label>Sélectionner une matière</mat-label>
              <mat-select formControlName="matiereId">
                <mat-option *ngFor="let matiere of matieres" [value]="matiere.id">
                  {{ matiere.code }} - {{ matiere.libelle }}
                </mat-option>
              </mat-select>
              <mat-error *ngIf="affectationForm.get('matiereId')?.hasError('required')">
                Matière requise
              </mat-error>
            </mat-form-field>
          </div>

          <div class="form-actions">
            <button mat-raised-button color="primary" type="submit" [disabled]="loading || affectationForm.invalid">
              {{ loading ? 'En cours...' : 'Affecter' }}
            </button>
          </div>
        </form>
      </div>

      <!-- LISTE DES AFFECTATIONS -->
      <div class="affectations-list">
        <h3>Liste des Affectations</h3>
        <table mat-table [dataSource]="enseignantsWithMatieres" class="mat-elevation-z8">
          
          <ng-container matColumnDef="matricule">
            <th mat-header-cell *matHeaderCellDef>Matricule</th>
            <td mat-cell *matCellDef="let enseignant">{{ enseignant.matricule }}</td>
          </ng-container>

          <ng-container matColumnDef="nom">
            <th mat-header-cell *matHeaderCellDef>Nom</th>
            <td mat-cell *matCellDef="let enseignant">{{ enseignant.nom }}</td>
          </ng-container>

          <ng-container matColumnDef="prenom">
            <th mat-header-cell *matHeaderCellDef>Prénom</th>
            <td mat-cell *matCellDef="let enseignant">{{ enseignant.prenom }}</td>
          </ng-container>

          <ng-container matColumnDef="matieres">
            <th mat-header-cell *matHeaderCellDef>Matières</th>
            <td mat-cell *matCellDef="let enseignant">
              <div class="matieres-chips" *ngIf="enseignant.matieres && enseignant.matieres.length > 0">
                <mat-chip-set>
                  <mat-chip *ngFor="let matiere of enseignant.matieres">
                    {{ matiere.code }}
                    <button matChipRemove (click)="removeMatiere(enseignant.id, matiere.id)">
                      <mat-icon>cancel</mat-icon>
                    </button>
                  </mat-chip>
                </mat-chip-set>
              </div>
              <span class="no-matiere" *ngIf="!enseignant.matieres || enseignant.matieres.length === 0">
                Aucune matière
              </span>
            </td>
          </ng-container>

          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef>Actions</th>
            <td mat-cell *matCellDef="let enseignant">
              <span class="matiere-count">
                {{ enseignant.matieres?.length || 0 }} matière(s)
              </span>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
        </table>
      </div>
    </mat-card-content>
  </mat-card>
</div>